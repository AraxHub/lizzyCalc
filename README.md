# ClickHouse в lizzyCalc: зачем и как

## Что такое ClickHouse

**ClickHouse** — колоночная СУБД (OLAP), оптимизированная под **аналитические запросы**: агрегации (COUNT, SUM, AVG, GROUP BY), срезы по времени, фильтрация по измерениям. Данные хранятся **по колонкам**, а не по строкам: при запросе «сумма по операциям за день» читаются только нужные колонки, сжатие отличное, сканы быстрые. Для обычного CRUD и точечных обновлений по ключу ClickHouse не заточен — там batch-вставки и «читай много, пиши пачками».

Итого: не замена PostgreSQL (там заказы, пользователи, текущее состояние), а **отдельное хранилище для аналитики** по событиям/операциям.

---

## Зачем он нам в приложении

В lizzyCalc уже есть поток событий: после каждого расчёта мы пишем в Kafka топик `operations` (domain.Operation). Консьюмер пока только логирует.

**Идея:** консьюмер кроме логирования **пишет каждую операцию в ClickHouse**. Туда попадают: число1, число2, операция, результат, timestamp. Дальше можно строить:

- дашборды: сколько операций в час/день, разбивка по типу операции;
- простую аналитику: средний результат, топ операций;
- срезы по времени без нагрузки на основную БД (PostgreSQL остаётся для «истории» и консистентности, а тяжёлые агрегаты — из ClickHouse).

Архитектурно: **Kafka → консьюмер → ClickHouse** (плюс по желанию вызов `HandleOperationEvent` как сейчас). Один источник правды по событиям — топик; ClickHouse — материализованное представление для аналитики. REST-хэндлер типа `GET /api/v1/analytics/summary` ходит уже в ClickHouse (агрегаты), а не в PostgreSQL.

---

## Как устроен клиент и UI

**Драйвер в коде:** в Go обычно используют [clickhouse-go](https://github.com/ClickHouse/clickhouse-go) (официальный). Подключение по HTTP или нативному протоколу, batch-вставки через `PrepareBatch` + `Append` + `Send`. Порт по умолчанию — 8123 (HTTP) или 9000 (нативный).

**UI / клиент «как Redis Insight или Kafka UI»:** отдельного «официального» веб-клиента в одном образе с ClickHouse нет, но есть варианты:

| Инструмент | Что это | Как использовать |
|------------|--------|-------------------|
| **Tabix** | Веб-UI для ClickHouse (open source) | Поднять в compose рядом с ClickHouse, подключается по HTTP (порт 8123). Запросы, таблицы, экспорт. |
| **DBeaver** | Десктопный универсальный клиент | Поддержка ClickHouse из коробки, удобно для разработки и разовых запросов. |
| **Grafana** | Дашборды | Datasource ClickHouse — графики по результатам SQL-запросов (агрегаты по времени и т.д.). |
| **clickhouse-client** | CLI в образе ClickHouse | `docker exec -it ... clickhouse-client` — консольные запросы. |

Для локального стека в духе Redis Insight / Kafka UI разумно добавить в compose **Tabix**: один контейнер, веб-интерфейс на свой порт (например 8081), в настройках указываем `http://clickhouse:8123`. Так можно смотреть таблицы, выполнять SELECT и проверять, что консьюмер пишет данные.

Итого: клиент для приложения — библиотека **clickhouse-go**; для человека — **Tabix** в compose (аналог Kafka UI / Redis Insight) плюс при необходимости DBeaver или Grafana.
